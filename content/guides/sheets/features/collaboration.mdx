---
title: 协同编辑
icon: '#pro/CloudCheck'
---

<MetaData
  lang="en-US"
  meta={{
    preset: [{
      client: '@univerjs/preset-sheets-collaboration',
      locale: '@univerjs/preset-sheets-collaboration/locales/en-US',
      style: '@univerjs/preset-sheets-collaboration/lib/index.css',
    }],
    plugins: [{
      client: '@univerjs-pro/collaboration',
    }, {
      client: '@univerjs-pro/collaboration-client',
      facade: '@univerjs-pro/collaboration-client/facade',
      locale: '@univerjs-pro/collaboration-client/locale/en-US',
    }, {
      client: '@univerjs-pro/collaboration-client-ui',
      facade: '@univerjs-pro/collaboration-client-ui/facade',
      style: '@univerjs-pro/collaboration-client-ui/lib/index.css',
    }],
    server: 'Yes',
  }}
/>

<Callout type="warning" title="注意事项">
  协同编辑功能需要 Univer 服务端支持，请确保你已经正确安装并配置了 Univer 服务端。具体请参考：[升级到 Pro](/en-US/guides/sheets/getting-started/pro/introduction)
</Callout>

协同编辑功能允许多个用户同时编辑同一文档，实时同步更改，适用于团队协作和多人编辑场景。

## Preset Mode

### Installation

<Callout>
  @univerjs/preset-sheets-collaboration 的 `UniveSheetsCollaborationPreset` 预设在运行时依赖 `UniverSheetsDrawingPreset` 和 `UniverSheetsAdvancedPreset` 预设，请先安装 @univerjs/preset-sheets-drawing 和 @univerjs/preset-sheets-advanced。
</Callout>

```package-install
npm install @univerjs/preset-sheets-drawing @univerjs/preset-sheets-advanced @univerjs/preset-sheets-collaboration
```

### Usage

```typescript
import { UniverSheetsAdvancedPreset } from '@univerjs/preset-sheets-advanced' // [!code ++]
import UniverPresetSheetsAdvancedEnUS from '@univerjs/preset-sheets-advanced/locales/en-US' // [!code ++]
import { UniverSheetsCollaborationPreset } from '@univerjs/preset-sheets-collaboration' // [!code ++]
import UniverPresetSheetsCollaborationEnUS from '@univerjs/preset-sheets-collaboration/locales/en-US' // [!code ++]
import { UniverSheetsCorePreset } from '@univerjs/preset-sheets-core'
import UniverPresetSheetsCoreEnUS from '@univerjs/preset-sheets-core/locales/en-US'
import { UniverSheetsDrawingPreset } from '@univerjs/preset-sheets-drawing' // [!code ++]
import UniverPresetSheetsDrawingEnUS from '@univerjs/preset-sheets-drawing/locales/en-US' // [!code ++]
import { createUniver, LocaleType, merge } from '@univerjs/presets'

import '@univerjs/presets/lib/styles/preset-sheets-core.css'
import '@univerjs/preset-sheets-drawing/lib/index.css' // [!code ++]
import '@univerjs/preset-sheets-advanced/lib/index.css' // [!code ++]
import '@univerjs/preset-sheets-collaboration/lib/index.css' // [!code ++]

const { univerAPI } = createUniver({
  locale: LocaleType.En_US,
  locales: {
    [LocaleType.En_US]: merge(
      {},
      UniverPresetSheetsCoreEnUS,
      UniverPresetSheetsDrawingEnUS, // [!code ++]
      UniverPresetSheetsAdvancedEnUS, // [!code ++]
      UniverPresetSheetsCollaborationEnUS, // [!code ++]
    ),
  },
  collaboration: true, // [!code ++]
  presets: [
    UniverSheetsCorePreset(),
    UniverSheetsDrawingPreset({ // [!code ++]
      collaboration: true, // [!code ++]
    }), // [!code ++]
    UniverSheetsAdvancedPreset({ // [!code ++]
      collaboration: true, // [!code ++]
    }), // [!code ++]
    UniverSheetsCollaborationPreset({ // [!code ++]
      universerEndpoint: 'http://localhost:3010', // [!code ++]
    }), // [!code ++]
  ],
})
```

{/* ### Preset and Configuration */}

## Plugin Mode

### Installation

```package-install
npm install @univerjs-pro/collaboration @univerjs-pro/collaboration-client @univerjs-pro/collaboration-client-ui
```

### Usage

```typescript
import { UniverCollaborationPlugin } from '@univerjs-pro/collaboration' // [!code ++]
import { UniverCollaborationClientPlugin } from '@univerjs-pro/collaboration-client' // [!code ++]
import { BrowserCollaborationSocketService, UniverCollaborationClientUIPlugin } from '@univerjs-pro/collaboration-client-ui' // [!code ++]
import CollaborationClientEnUS from '@univerjs-pro/collaboration-client/locale/en-US' // [!code ++]
import { LocaleType, merge, Univer } from '@univerjs/core'

import '@univerjs-pro/collaboration-client/facade' // [!code ++]
import '@univerjs-pro/collaboration-client-ui/facade' // [!code ++]

import '@univerjs-pro/collaboration-client/lib/index.css' // [!code ++]

const univer = new Univer({
  locale: LocaleType.En_US,
  locales: {
    [LocaleType.En_US]: merge(
      {},
      CollaborationClientEnUS, // [!code ++]
    ),
  },
})

// 通过将 override 选项设置为 [[IAuthzIoService, null]]，可以告诉 Univer 不要注册内置的 IAuthzIoService。
// 通过将 override 选项设置为 [[IUndoRedoService, null]]，可以告诉 Univer 不要注册内置的 IUndoRedoService
// 这样，Univer 将使用 UniverCollaborationPlugin 中提供的服务作为权限、重做恢复服务的实现。
const univer = new Univer({
  override: [ // [!code ++]
    [IAuthzIoService, null], // [!code ++]
    [IUndoRedoService, null], // [!code ++]
  ], // [!code ++]
})

univer.registerPlugin(UniverCollaborationPlugin) // [!code ++]
univer.registerPlugin(UniverCollaborationClientPlugin, { // [!code ++]
  socketService: BrowserCollaborationSocketService, // [!code ++]
  authzUrl: 'http://localhost:3010/universer-api/authz', // [!code ++]
  snapshotServerUrl: 'http://localhost:3010/universer-api/snapshot', // [!code ++]
  collabSubmitChangesetUrl: 'http://localhost:3010/universer-api/comb', // [!code ++]
  collabWebSocketUrl: 'ws://localhost:3010/universer-api/comb/connect', // [!code ++]
}) // [!code ++]
univer.registerPlugin(UniverCollaborationClientUIPlugin) // [!code ++]
```

{/* ### Plugins and Configuration */}

## 协同文档数据

协同编辑插件依赖 Univer 服务，协同文档的数据存储在 Univer 服务中。

### `unitId`

每篇协同文档在 Univer 服务中都有一个唯一的 `unitId`。Univer 协同客户端使用 `unitId` 可从 Univer 服务获取到对应的协同文档数据进行协同编辑。

### `type`

`type` 是协同文档的类型，协同文档的类型决定了协同文档的初始数据结构。

## 创建协同文档

有多种方式在 Univer 服务中创建协同文档：

- 通过[创建文档](/en-US/guides/pro/api#创建文档)接口可以创建一篇空白文档。
- 通过[导入插件](/en-US/guides/sheets/features/import-export)提供的 `FUniver.importXLSXToUnitIdAsync` 方法，将 `.xlsx` 文件导入到 Univer 服务。

## 通过 URL 参数加载协同文档

@univerjs-pro/collaboration-client 插件内部提供了根据 URL 参数 `unit` 和 `type` 自动加载对应的数据的功能，这可以简化一些场景下的数据加载逻辑。

如果你想使用该特性，你需要适当地修改一下原有的加载数据逻辑，并将 `unit` 和 `type` 参数添加到 URL 中，如下所示：

```typescript
import { UniverInstanceType } from '@univerjs/core'
// 预设模式下 `UniverInstanceType` 可从 @univerjs/presets 导入
import { UniverInstanceType } from '@univerjs/presets'

// 原有逻辑，只适用于非协同文档
univer.createUnit(UniverInstanceType.UNIVER_SHEET, {}) // [!code --]

// 修改后的逻辑，适用于协同文档
const url = new URL(window.location.href) // [!code ++]
const unit = url.searchParams.get('unit') // [!code ++]

if (unit) { // [!code ++]
  // 如果 URL 中包含 unit 参数，则自动加载数据
} else { // [!code ++]
  // 创建一个新的文档
  fetch(`/universer-api/snapshot/${UniverInstanceType.UNIVER_SHEET}/unit/-/create`, { // [!code ++]
    method: 'POST', // [!code ++]
    headers: { // [!code ++]
      'Content-Type': 'application/json', // [!code ++]
    }, // [!code ++]
    body: JSON.stringify({ // [!code ++]
      type: UniverInstanceType.UNIVER_SHEET, // instance type // [!code ++]
      name: 'New Sheet By Univer', // workbook name // [!code ++]
      creator: 'user', // creator name // [!code ++]
    }), // [!code ++]
  }).then((response) => { // [!code ++]
    if (!response.ok) { // [!code ++]
      throw new Error('create unit failed') // [!code ++]
    } // [!code ++]
    return response.json() // [!code ++]
  }).then((data) => { // [!code ++]
    if (!data.unitID) { // [!code ++]
      throw new Error('create unit failed') // [!code ++]
    } // [!code ++]
    url.searchParams.set('unit', data.unitID) // [!code ++]
    url.searchParams.set('type', String(UniverInstanceType.UNIVER_SHEET)) // [!code ++]
    window.location.href = url.toString() // [!code ++]
  }).catch((error) => { // [!code ++]
    console.error(error) // [!code ++]
  }) // [!code ++]
} // [!code ++]
```

## Facade API

### 加载协同文档

如果你不想使用 URL 参数来加载协同文档，你也可以通过 Facade API 来加载协同文档。

```typescript
const collaboration = univerAPI.getCollaboration()
const workbook = await collaboration.loadSheetAsync('your-unit-id')
```

## 拓展阅读

如果你想进一步了解协同编辑的工作原理，可以阅读以下文章：

- [《OT 算法以及 Univer 的协同编辑设计》](/en-US/blog/ot)
