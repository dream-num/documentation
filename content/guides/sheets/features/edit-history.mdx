---
title: 编辑历史
icon: '#pro/History'
---

<MetaData
  lang="en-US"
  meta={{
    preset: [{
      client: '@univerjs/preset-docs-collaboration',
      locale: '@univerjs/preset-docs-collaboration/locales/en-US',
      style: '@univerjs/preset-docs-collaboration/lib/index.css',
    }],
    plugins: [{
      client: '@univerjs-pro/edit-history-loader',
    }, {
      client: '@univerjs-pro/edit-history-viewer',
      facade: '@univerjs-pro/edit-history-viewer/locale/en-US',
      style: '@univerjs-pro/edit-history-viewer/lib/index.css',
    }],
    server: 'Yes',
  }}
/>

<Callout type="warning" title="Caution">
  The edit history functionality requires support from the Univer server. Please ensure that you have correctly installed and configured the Univer server. For details, please refer to: [Upgrading to Pro](/en-US/guides/pro)
</Callout>

编辑历史功能允许用户查看和恢复文档的历史版本，支持多种过滤和搜索方式，帮助用户高效管理文档内容。

## Preset Mode

### Installation

<Callout>
  The `UniverSheetsAdvancedPreset` preset from `@univerjs/preset-sheets-advanced` depends on the `UniverSheetsDrawingPreset` preset at runtime. Please install `@univerjs/preset-sheets-drawing` first.
</Callout>

```package-install
npm install @univerjs/preset-sheets-drawing @univerjs/preset-sheets-advanced
```

### Usage

```typescript
import { UniverSheetsAdvancedPreset } from '@univerjs/preset-sheets-advanced' // [!code ++]
import UniverPresetSheetsAdvancedEnUS from '@univerjs/preset-sheets-advanced/locales/en-US' // [!code ++]
import { UniverSheetsCorePreset } from '@univerjs/preset-sheets-core'
import UniverPresetSheetsCoreEnUS from '@univerjs/preset-sheets-core/locales/en-US'
import { UniverSheetsDrawingPreset } from '@univerjs/preset-sheets-drawing' // [!code ++]
import UniverPresetSheetsDrawingEnUS from '@univerjs/preset-sheets-drawing/locales/en-US' // [!code ++]
import { createUniver, LocaleType, merge } from '@univerjs/presets'

import '@univerjs/preset-sheets-core/lib/index.css'
import '@univerjs/preset-sheets-drawing/lib/index.css' // [!code ++]
import '@univerjs/preset-sheets-advanced/lib/index.css' // [!code ++]

const { univerAPI } = createUniver({
  locale: LocaleType.En_US,
  locales: {
    [LocaleType.En_US]: merge(
      {},
      UniverPresetSheetsCoreEnUS,
      UniverPresetSheetsDrawingEnUS, // [!code ++]
      UniverPresetSheetsAdvancedEnUS, // [!code ++]
    ),
  },
  presets: [
    UniverSheetsCorePreset(),
    UniverSheetsDrawingPreset(), // [!code ++]
    UniverSheetsAdvancedPreset({ // [!code ++]
      universerEndpoint: 'http://localhost:3010', // [!code ++]
    }), // [!code ++]
  ],
})
```

如果你拥有 Univer 的商业许可证，请参考[在客户端使用许可证](/en-US/guides/pro/license#在预设模式中使用)进行配置。

### Preset and Configuration

`UniverSheetsAdvancedPreset` 配置项：

```typescript
interface IUniverSheetsAdvancedPresetConfig {
  // Univer Server 的端口地址
  universerEndpoint?: string
  exchangeClientOptions?: {
    // 导入后工作表的最小行数
    minSheetRowCount?: number
    // 导入后工作表的最小列数
    minSheetColumnCount?: number
  }
}
```

## Plugin Mode

### Installation

```package-install
npm install @univerjs-pro/edit-history-viewer @univerjs-pro/edit-history-loader
```

### Usage

```typescript
import { UniverEditHistoryLoaderPlugin } from '@univerjs-pro/edit-history-loader' // [!code ++]
import EditHistoryViewerEnUS from '@univerjs-pro/edit-history-viewer/locale/en-US' // [!code ++]
import { LocaleType, merge, Univer } from '@univerjs/core'

import '@univerjs-pro/edit-history-viewer/lib/index.css' // [!code ++]

const univer = new Univer({
  locale: LocaleType.En_US,
  locales: {
    [LocaleType.En_US]: merge(
      {},
      EditHistoryViewerEnUS, // [!code ++]
    ),
  },
})

univer.registerPlugin(UniverEditHistoryLoaderPlugin, { // [!code ++]
  univerContainerId: 'your-univer-container-id', // [!code ++]
}) // [!code ++]
```

如果你拥有 Univer 的商业许可证，请参考[在客户端使用许可证](/en-US/guides/pro/license#在插件模式中使用)进行配置。

### Plugins and Configuration

`UniverExchangeClientPlugin` 配置项：

```typescript
interface IUniverExchangeClientConfig {
  // Univer Server 的配置
  downloadEndpointUrl?: string
  uploadFileServerUrl?: string
  importServerUrl?: string
  exportServerUrl?: string
  getTaskServerUrl?: string
  signUrlServerUrl?: string
  // 最大超时时间，单位为毫秒
  maxTimeoutTime?: number
  options?: {
    // 导入后工作表的最小行数
    minSheetRowCount?: number
    // 导入后工作表的最小列数
    minSheetColumnCount?: number
  }
}
```

启动历史记录时，`UniverEditHistoryLoaderPlugin` 会加载一个新的 Univer 实例挂载指定 DOM 节点上。因此在注册时，需要提供合适的 DOM 节点 id（如原 Univer 实例的 Container），以达到历史记录面板覆盖原 Univer 面板的目的。若节点 id 未指定，则默认为  `univer-container`。

## Feature 适配

历史记录的 Univer 实例中只会默认加载官方的 Plugin。为业务需求开发的第三方 Feature Plugin 需要被注册到 `HistoryLoaderService` 后，才会被正确的显示在历史记录中。

对已经内置注册的官方 Plugin，也可以修改其配置。

在 `HistoryLoaderService` 中，你还可以获取或订阅历史记录的 Univer 实例，用于支持更多的拓展操作。

```typescript
import { HistoryLoaderService } from '@univerjs-pro/edit-history-loader'
// Presets 引入: import { HistoryLoaderService } from '@univerjs/presets/preset-sheets-collaboration';

const disposable = univerAPI.addEvent(univerAPI.Event.LifeCycleChanged, ({ stage }) => {
  if (stage === univerAPI.Enum.LifecycleStages.Steady) {
    const injector = univer.__getInjector()
    const historyLoaderService = injector.get(HistoryLoaderService)

    // 和 PluginService 的注册方式一致，历史记录的 Univer 实例在新建后会按照以下配置来注册对应 Plugin
    historyLoaderService.registerPlugin(YourPlugin, YourPluginConfig)
    // 配置官方已注册的 Plugin, 需设置 true 参数表示覆盖原配置
    historyLoaderService.registerPlugin(ExamplePlugin, ExamplePluginConfig, true)

    // 如果加载了历史记录，则可以直接获取到历史记录的 Univer 实例
    const historyUniver = historyLoaderService.historyUniver
  }
})

// 移除事件监听器，使用 `disposable.dispose()`
```
